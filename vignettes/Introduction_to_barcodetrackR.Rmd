---
title: "barcodetrackR"
#date: "`r format(Sys.Date(), "%d %B %Y")`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: false
    css: readthedown_custom_2.css
---


``` {r setup, echo = FALSE}
#knitr::opts_chunk$set(width = 100)
```

# Introduction

## Motivation
[barcodetrackR](http://github.com/d93espinoza/barcodetrackR) is an R package developed for the analysis and visualization of clonal tracking data from cellular barcoding experiments.

## Installation
Currently, [barcodetrackR](http://github.com/d93espinoza/barcodetrackR) is available at Github and can be downloaded using the devtools package.
```{r installation, eval = FALSE}
devtools::install_github("d93espinoza/barcodetrackR")
```

## Contributors
The R package and functions were created by Diego A. Espinoza, Ryland Mortlock, Samson J. Koelle, and others at Cynthia Dunbar's laboratory at the National Heart, Lung, and Blood Institutes of Health. Issues should be addressed to https://github.com/d93espinoza/barcodetrackR/issues.


# Loading data

## Loading required packages

The [barcodetrackR](http://github.com/d93espinoza/barcodetrackR) package operates on [SummarizedExperiment](https://bioconductor.org/packages/release/bioc/html/SummarizedExperiment.html) objects from the Bioconductor repository. It stores associated colData for each sample in this object as well as any metadata. We load the `barcodetrackR` and `SummarizedExperiment` packages here for our analyses, as well as the `magrittr` package in order to improve legibility of code through using the pipe `%>%` operator.

```{r load packages required, eval = TRUE, warning=FALSE, message=FALSE}

require("magrittr")
require("barcodetrackR")
require("SummarizedExperiment")

```

## Creating objects with `create_SE`

For this vignette, we will load publically available data from the following papers (these sample datasets are included in the R package):

* [Wu, Chuanfeng, et al. "Clonal expansion and compartmentalized maintenance of rhesus macaque NK cell subsets." Science Immunology (2018)](http://dx.doi.org/10.1126/sciimmunol.aat9781)
* [Belderbos, Mirjam E., et al. "Donor-to-Donor Heterogeneity in the Clonal Dynamics of Transplanted Human Cord Blood Stem Cells in Murine Xenografts." Biology of Blood and Marrow Transplantation (2020)](http://dx.doi.org/10.1016/j.bbmt.2019.08.026)
* [Six, Emmanuelle, et al. "Clonal tracking in gene therapy patients reveals a diversity of human hematopoietic differentiation programs." Blood (2020)](http://doi.org/10.1182/blood.2019002350)

```{r load data, eval = TRUE}

system.file("sample_data/WuC_etal/monkey_ZJ31.txt", package = "barcodetrackR") %>%
  read.delim(row.names = 1) -> wu_dataframe

system.file("sample_data/WuC_etal/monkey_ZJ31_metadata.txt", package = "barcodetrackR") %>%
  read.delim() -> wu_metadata

wu_SE <- create_SE(your_data = wu_dataframe,
                   meta_data = wu_metadata,
                   threshold = 0)


system.file("sample_data/BelderbosME_etal/mouse_UBC_C22.txt", package = "barcodetrackR") %>%
  read.delim(row.names = 1) -> belderbos_dataframe

system.file("sample_data/BelderbosME_etal/mouse_UBC_C22_metadata.txt", package = "barcodetrackR") %>%
  read.delim() -> belderbos_metadata

belderbos_SE <- create_SE(your_data = belderbos_dataframe,
                          meta_data = belderbos_metadata,
                          threshold = 0)


system.file("sample_data/SixE_etal/WAS5_reads.txt", package = "barcodetrackR") %>%
  read.delim(row.names = 1) -> six_dataframe

system.file("sample_data/SixE_etal/WAS5_metadata.txt", package = "barcodetrackR") %>%
  read.delim() -> six_metadata

six_SE <- create_SE(your_data = six_dataframe,
                    meta_data = six_metadata,
                    threshold = 0)

```

In addition to reads data, the Six et al. paper includes "estimated abundance" data for each of these timepoints. We load these into a new SE in order to compare our analyses downstream.

```{r load custom counts, eval = TRUE}

system.file("sample_data/SixE_etal/WAS5_estabundance.txt", package = "barcodetrackR") %>%
  read.delim( row.names = 1) -> six_dataframe_2

six_ea_SE <- create_SE(your_data = six_dataframe_2,
                    meta_data = six_metadata,
                    threshold = 0)

```

Our input dataframes to create the `SummarizedExperiment` (SE) objects are each an n x m `data.frame` where there are n rows of observations (typically cellular barcodes, insertion sites, or the like) and the m columns are the samples. The input metadata must have row order identical to the order of the colums in its corresponding dataframe. The metadata must also have a column titled `SAMPLENAME` that denotes the column of `your_data` it refers to.

## Assays created by `create_SE`

`create_SE` takes the input `dataframe` and metadata and creates a SummarizedExperiment object with the following assays:

* `counts`: the raw values from the input dataframe
* `percentages`: the per-column proportions of each entry in each column
* `ranks`: the rank of each entry in each column
* `normalized`: the normalized read values (CPM)
* `logs`: the log of the normalized values

```{r list assays, eval = TRUE}
assays(six_SE)
```

# Correlations

## `scatter_plot`
A straightforward way to view the relationship between samples in a pairwise manner is to view basic scatter plots of two samples using the provided assays. We provide a `scatter_plot` function as part of the package.

Here, we view the correlation of barcode counts between different cell types at the 20 month timepoint of the Wu et al study. We compare granulocytes (Gr) to B and T cells.

```{r scatter_plot, eval = TRUE, fig.width = 7, fig.height=4}
Gr_B_20 <- c("ZJ31_20m_Gr", "ZJ31_20m_B")
Gr_T_20 <- c("ZJ31_20m_Gr", "ZJ31_20m_T")
wu_scatterplot_1 <- scatter_plot(wu_SE[,Gr_B_20], your_title = "Gr vs B")
wu_scatterplot_2 <- scatter_plot(wu_SE[,Gr_T_20], your_title = "Gr vs T")
cowplot::plot_grid(wu_scatterplot_1, wu_scatterplot_2, ncol = 2)
```

## `cor_plot`
A more comprehensive way to view the relationship between samples in a pairwise manner is to use a correlation plot. Here, we view the Pearson correlation between the T, B, Gr, NK CD56+/CD16-, and NK CD56-/CD16+ fractions within the Wu dataset for the 6, 9.5, 12, and 20 month post-transplant timepoints.
```{r cor_plot 1, eval = TRUE, fig.width = 6, fig.height = 5}
wu_cor_plot_sample_selection <- colData(wu_SE)$SAMPLENAME[1:20]
cor_plot(wu_SE[,wu_cor_plot_sample_selection],
         method_corr = "pearson",
         plot_type = "color")
```

We can also use the spearman correlation as our metric of interest, and visualize our correlation plot using circles with areas proportional to the absolute value of the correlation and colors corresponding to the value of the correlations.
```{r cor_plot 2, eval = TRUE, fig.width = 6, fig.height = 5, warning=FALSE, message=FALSE}
cor_plot(wu_SE[,wu_cor_plot_sample_selection],
         method_corr = "spearman",
         plot_type = "circle")
```

We can return a table of the Pearson correlations as well as the p-values and confidence intervals for each of the comparisons above.
```{r cor_plot 3, eval = TRUE}
cor_plot(wu_SE[,wu_cor_plot_sample_selection],
         method_corr = "pearson",
         return_table = TRUE) %>% head
```

Above, we used two of the three available correlation visualizations (`"color"` and `"circle"`) using the standard color palette provided. A `no_negative` parameter is offered as well to eliminate negative correlations within the data, from which deriving biological meaning may be difficult.

When there are a smaller number of samples to analyze, the `"number"` option can be used to view the actual correlation within the grid. Here is an example comparing the pearson correlation of clones within peripheral blood at subsequent timepoints from the belberdos sample data set.

```{r cor_plot 4, eval = TRUE, fig.width = 3, fig.height = 2, warning=FALSE, message=FALSE}
belderbos_wk_samples_PB <- c("wk10", "wk14", "wk20", "wk27", "wk33")
cor_plot(your_SE = belderbos_SE[,belderbos_wk_samples_PB],
         method_corr = "pearson",
         plot_type = "number",
         number_size = 3)
```

# Clonal patterns

## `barcode_ggheatmap`

A useful visualization to study clonal patterns over time is by using a heat map which clusters the top clones based on relatedness and displays their proportion in each sample over time. Our function `barcode_ggheatmap` does this by choosing the top N clones (`n_clones`) within each sample and tracking them over time. The argument `n_clones` assumes that in most cases, the large-contributing clones are of most interest to the user. This assumption can be relaxed by passing a large value to the argument. 

We first visualize the top 10 clones from the selected samples in the Wu dataset. The default cell note is stars for the top 10 clones in each sample.

```{r barcode_ggheatmap wu_SE 1, echo=TRUE, warning = FALSE, fig.width = 12, fig.height=10}
barcode_ggheatmap(your_SE = wu_SE[,wu_cor_plot_sample_selection],
                  n_clones = 10,
                  label_size = 14,
                  cellnote_size = 4)
```

We can also visualize the percentage contribution of each of these clones and add a dendogram which clusters clones based on the Euclidean distance between each clone's log assay. Here we plot the top 5 clones within the Six dataset. First, we order the columns to group them by celltype.

```{r barcode_ggheatmap six_SE, echo=TRUE, warning = FALSE, fig.width = 12, fig.height=10}
six_celltype_order <- c("m13_TCELLS", "m36_TCELLS", "m43_TCELLS", "m55_TCELLS",
                        "m13_BCELLS", "m36_BCELLS", "m43_BCELLS", "m55_BCELLS",
                        "m13_NKCELLS", "m36_NKCELLS", "m43_NKCELLS","m55_NKCELLS",
                        "m13_GRANULOCYTES", "m36_GRANULOCYTES", "m43_GRANULOCYTES",
                        "m55_GRANULOCYTES",
                        "m13_MONOCYTES", "m36_MONOCYTES", "m43_MONOCYTES","m55_MONOCYTES")

barcode_ggheatmap(your_SE = six_SE[,six_celltype_order],
                  n_clones = 5,
                  cellnote_assay = "percentages",
                  cellnote_size = 2,
                  label_size = 14,
                  dendro = TRUE,
                  clusters = 4,
                  distance_method = "euclidean")
```

Splitting the clones into 4 clusters makes it easy to identify clones which are biased towards Monocytes (*purple*), T cells (*green*), NK cells (*light blue*), and B cell / Granulocyte (*red*).

The Belderbros dataset generally contains less clones than either the Wu or Six datasets, likely because the data is from mice.  When possible, using the "percentages" option of the `cellnote_assay` aqrgument provides maximal information.

```{r barcode_ggheatmap belderbos_SE, echo=TRUE, warning = FALSE, fig.width = 7, fig.height = 5}
belderbos_wk_samples_PB <- c("wk10", "wk14", "wk20", "wk27", "wk33")
barcode_ggheatmap(your_SE = belderbos_SE[,belderbos_wk_samples_PB],
                  n_clones = 10,
                  label_size = 18,
                  dendro = TRUE,
                  cellnote_size = 4,
                  cellnote_assay = "percentages",
                  clusters = 4)
```

Compared to the other data sets, this one generally shows a smaller number of clones making up a large proportion of the hematopoiesis.

## `barcode_binary_heatmap`

In some cases, we may be interested in a global view of the presence or absence of barcodes across samples, regardless of read abundance. In that case, a binary heat map can be generated using `barcode_binary_heatmap` to give the simplest visual representation. Here we view the binary heat map of the belderbos data with a threshold of 0.01, meaning clones that make up less than 1% of a sample are treated as not detected.

```{r binary_heat_map, echo=TRUE, warning = FALSE, eval = TRUE}
barcode_binary_heatmap(your_SE = belderbos_SE[,belderbos_wk_samples_PB],
                       label_size = 12,
                       threshold = 0.01)
```

## `clonal_contribution`

Another familiar way to visualize clonal patterns over time is using a line or bar chart showing the proportion of top clones. In the above heat maps for wu data, we could see that there are some large uni-lineage CD56-/CD16+ NK cell clones. We can view the expansion of the top clones from the final timepoint through a stacked area line chart showing the proportion of each clone in CD56-/CD16+ NK cell samples across time.

```{r clonal_contribution wu_SE, echo=TRUE, warning = FALSE}

clonal_contribution(your_SE = wu_SE[,17:20],
                    SAMPLENAME_choice = "ZJ31_20m_NK_CD56n_CD16p",
                    n_clones = 10,
                    graph_type = "line",
                    plot_over = "months")
```

The colored clones represent the top 10 clones in the 20 month CD56-/CD16+ NK sample. The gray clones are other smaller clones which are found in the CD16+ samples at any of the four timepoints.

For data with fewer clones, a bar chart might be appropriate. We can view the peripheral blood samples from the belderbos dataset, previously shown as a heat map. By turning the `plot_non_selected` argument to false, we can only look at the top 10 clones from the chosen sample and ignore. We can also use categorical spacing on the x-axis rather than numeric by setting keep_numeric to false.

```{r clonal_contribution belderbos_SE, echo=TRUE, warning = FALSE, eval = TRUE}
clonal_contribution(your_SE = belderbos_SE[,belderbos_wk_samples_PB],
                    SAMPLENAME_choice = "wk33",
                    n_clones = 10,
                    graph_type = "bar",
                    plot_over = "weeks",
                    keep_numeric = FALSE,
                    plot_non_selected = FALSE)
```

# Clonal Bias

## `ridge_plot`

The ridge plot function calculates the density of clones at different values of bias between two selections. Note that log_bias is calculated as log(selection_1/selection_2 + 1) so that it can handle clones which are zero in one of the samples. If the `"plot_by"` argument is provided, the ridge plot will have a y axis corresponding to samples along the variable provided which must be a column of colData. 

Here, we view a ridge plot showing clonal bias between B and T cells from the Wu dataset for the 6, 9.5, 12, and 20 month post-transplant timepoints.

```{r ridge_plot wu_SE 1, echo=TRUE, warning = FALSE, eval = TRUE}
wu_ridge_plot_sample_selection <- colData(wu_SE)$SAMPLENAME[1:20]

wu_ridge_plot <- ridge_plot(your_SE = wu_SE[,wu_ridge_plot_sample_selection],
                            selection_var = "celltype",
                            selection_1 = "B",
                            selection_2 = "T",
                            plot_by = "timepoint")

suppressMessages(plot(wu_ridge_plot)) # Supress message on which bandwith is chosen
```

By default, the ridge plot calculates the density of clones at each value of the log bias. It does not consider the fractional contribution of the clones. If you want larger clones to be more influential to the density estimation, set weighted = TRUE to make a weighted heat map.

```{r ridge_plot wu_SE 2, echo=TRUE, warning = FALSE, eval = TRUE}
wu_ridge_plot_weighted <- ridge_plot(your_SE = wu_SE[,wu_ridge_plot_sample_selection],
                                     selection_var = "celltype",
                                     selection_1 = "B",
                                     selection_2 = "T",
                                     plot_by = "timepoint",
                                     weighted = TRUE)

suppressMessages(plot(wu_ridge_plot_weighted)) # Supress message on which bandwith is chosen
```

For this dataset, the weighted heat map shows a more balanced (less biased) clonality between B and T cells as compared to the regular ridge plot. This means that although there are highly biased clones, the larger clones tend to be shared between B and T cells.

Creating a ridge plot based on the Six et al data also shows that the clonality between B and T cells (as assessed by viral integration site analysis) becomes less biased over time.

```{r ridge_plot six_SE, echo=TRUE, warning = FALSE, eval = TRUE}
six_ridge_plot <- ridge_plot(your_SE = six_SE,
                             selection_var = "celltype",
                             selection_1 = "B",
                             selection_2 = "T",
                             plot_by = "months")

suppressMessages(plot(six_ridge_plot))
```

## `bias_histogram`




## `bias_distribution_barplot`




## `ternary_plot`




# Diversity

## `clonal_diversity`
Within-sample diversity indices (also referred to as alpha diversities) are indices computed independently for each sample in a data set. With clonal tracking, these diversity indices can give a global indication about the number of species in a sample using the number of detected species as input and sometimes also leveraging the proportional abundances of species within the sample. We include the function `clonal_diversity` which can calculate three diversity indices (making use the [`vegan`](https://cran.r-project.org/web/packages/vegan/) package):

* `"shannon"` $H'=-\sum _{i=1}^{R}p_{i}\ln p_{i}$
* `"simpson"` $\lambda =\sum _{i=1}^{R}p_{i}^{2}$
* `"invsimpson"`${\displaystyle {\frac {1}{\lambda }}={1 \over \sum _{i=1}^{R}p_{i}^{2}}={}^{2}D}$

We also include `"count"` as an option for `index_type` in order to use the total detected clones per sample as a measure for diversity.

As an example, we can plot the shannon diversities for the 5 cell types within the Wu dataset over time.
```{r wu shannon, eval = TRUE}
clonal_diversity(wu_SE[,1:20], plot_over = "months", group_by = "celltype", index_type = "shannon")
```

Here we show the simpson indices for the unsorted samples in the Belderbos dataset over time; the last time point splits the cell fraction in to T, B, and Granulocyte fractions, allowing comparison of their simpson indices.
```{r belderbos simpson, eval = TRUE}
clonal_diversity(belderbos_SE, plot_over = "weeks", group_by = "cell.type", index_type = "simpson")
```

Similar to the Wu dataset, the Six dataset contains clonal tracking information for the T, B, Gr, Monocyte, and NK lineages. We can plot these over time as well and interstingly observe that the shannon diversity of the NK cell fraction follows a similar pattern to that of the Wu dataset.
```{r six shannon, eval = TRUE}
clonal_diversity(six_SE, plot_over = "months", group_by = "celltype", index_type = "shannon")
```


## `mds_plot`
Measures of simmilarity or dissimialrity between samples are known as beta-diversity indices (or distances if they are metrics). A common way for depicting these beta-diversity indices are using what are known as PCoA (Principal Coordinate Analysis) plots, in which an input distance matrix is plotted in two dimensions. Again, we leverage the `"vegan"` package here to call `vegandist` which allows us to calculate a number of dissimilarity indices between our samples (choosing an assay from the `SummarizedExperiment` object) and then perform principal coordinates analysis using `cmdscale`. Note that using `"euclidean"` as our index is equivalent to performing PCA (Prinicipal Components Analysis) on our data. 




## `rank_abundance`

# Circos

# Utilities





