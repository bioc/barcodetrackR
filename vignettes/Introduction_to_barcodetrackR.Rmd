---
title: "Introduction to barcodetrackR"
author: "Ryland Mortlock and Diego A. Espinoza"
date: Last compiled on `r format(Sys.Date(), "%d %B %Y")`
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Required packages
require("magrittr")
require("barcodetrackR")

```

## Load the sample data

The _barcodetrackR_ package includes sample data from published cellular barcoding experiments. For this vignette, we will load data from publically available data from the following papers:

* Wu, Chuanfeng, et al. "Clonal expansion and compartmentalized maintenance of rhesus macaque NK cell subsets." Science Immunology 3.29 (2018): eaat9781.
* Belderbos, Mirjam E., et al. "Donor-to-Donor Heterogeneity in the Clonal Dynamics of Transplanted Human Cord Blood Stem Cells in Murine Xenografts." Biology of Blood and Marrow Transplantation 26.1 (2020): 16-25.
* Six, E., et al. "Clonal tracking in gene therapy patients reveals a diversity of human hematopoietic differentiation programs." Blood (2020).

The package uses the R object type SummarizedExperiment to store barcoding data and its associated metadata.

```{r load_data, eval = TRUE}
wu_dataframe <- read.delim(system.file("sample_data", "WuC_etal/monkey_ZJ31.txt", package = "barcodetrackR"), row.names = 1)
wu_metadata <- read.delim(system.file("sample_data", "WuC_etal/monkey_ZJ31_metadata.txt", package = "barcodetrackR"))
wu_SE <- create_SE(your_data = wu_dataframe, meta_data = wu_metadata)

barcode.mouse <- read.delim('/Users/mortlockrd/Desktop/GitHub/barcodetrackR/inst/sample_data/mouseUBC/mouse_UBC_C22.txt', row.names = 1)
meta.mouse <- read.delim('/Users/mortlockrd/Desktop/GitHub/barcodetrackR/inst/sample_data/mouseUBC/mouse_UBC_C22_metadata.txt')
se.mouse <- create_SE(your_data = barcode.mouse, meta_data = meta.mouse, threshold = 5e-6)
```

## Heat map

The main way to view clonal patterns over time is through a heat map which clusters top barcodes based on relatedness and displays their proportion in each sample over time.

```{r heat_map, echo=TRUE, warning = FALSE}
# First we will use subset_SE to only keep the data we want to display in the heat map
se.monkey.sub <- subset_SE(se.monkey, Timepoint = c("6m","9.5m","12m","20m"), 
                                      Cell_type = c("Gr","T","B","NK_CD56n_CD16p","NK_CD56p_CD16n"))

# Next we will order the data first by timepoint then by cell type. 
se.monkey.sub@colData$Cell_type <- ordered(se.monkey.sub@colData$Cell_type, levels = c("Gr","T","B","NK_CD56n_CD16p","NK_CD56p_CD16n")) # Set the desired order of cell types
se.monkey.byTime <- se.monkey.sub[,with(se.monkey.sub@colData, order(se.monkey.sub@colData$Months,se.monkey.sub@colData$Cell_type))]
  
# Create the heat map using predominantly default parameters
barcode_ggheatmap_2(your_SE = se.monkey.byTime, n_clones = 10, label_size = 8, 
                    your_title = "Monkey ZJ31 Heatmap Grouped by Timepoint")
```

Now what if we wanted to group the samples by cell type instead to see the clonal changes within each cell type across time? Let's switch the order of the SE and also explore some of the user-defined parameters to the heat map function.

```{r heat_map_fancy, echo=TRUE, warning = FALSE}
# Order by cell type
se.monkey.byCellType <- se.monkey.sub[,with(se.monkey.sub@colData, order(se.monkey.sub@colData$Cell_type,se.monkey.sub@colData$Months))]

# Load library for the custom color pallete we will use
library(viridis)

# Make a customized heat map
barcode_ggheatmap_2(your_SE = se.monkey.byCellType,
                    plot_labels = NULL, 
                    n_clones = 10,
                    your_title = "ZJ31 Heatmap Grouped by Cell Type",
                    grid = TRUE,
                    label_size = 6,
                    dendro = TRUE,
                    cellnote_size = 3,
                    distance_method = "Euclidean",
                    minkowski_power = 2,
                    cellnote_assay = "stars",
                    hclust_linkage = "complete",
                    row_order = "hierarchical",
                    clusters = 4,
                    percent_scale = c(0, 0.00001, 0.001, 0.01, 0.1, 1),
                    color_scale = viridis(6))
```

Here, the hierarchical clustering helps visually identify four groups of clones. The largest (red bar) is present in all lineages except CD16+ NK cells. The small blue bar is a set of clones predominantly in Granulocytes and CD56+ NK cells. The green bar clustered clones that are present in B and T cells. And the purple bar signifies large unilieage CD16+ NK biased clones.

The mouse dataset generally contains less clones than the monkey. Let's make a heat map showing some detailed information about the top clones from the peripheral blood samples across time. 

```{r heat_map_mouse, echo=TRUE, warning = FALSE}
# Subset to only include peripheral blood samples
se.mouse.sub <- subset_SE(se.mouse, Source = "PB") 

# Order by timepoint
se.mouse.byTime <- se.mouse.sub[, with(se.mouse.sub@colData, order(se.mouse.sub@colData$Weeks))]

# Make a detailed heat map
barcode_ggheatmap_2(your_SE = se.mouse.byTime,
                    n_clones = 10,
                    your_title = "Mouse C22 Heatmap",
                    label_size = 12,
                    dendro = TRUE,
                    cellnote_size = 3,
                    cellnote_assay = "percentages",
                    clusters = 4)
```

Compared to the monkey, the mouse data generally shows a smaller number of clones making up a large proportion of the hematopoiesis.

## Binary heat map

In some cases, we may be interested in simply which barcodes are present in which samples. In that case, a binary heat map can give the simplest visual representation. 

```{r binary_heat_map, echo=TRUE, warning = FALSE}
barcode_binary_heatmap(your_SE = se.mouse.byTime,
                       threshold = 0.01,
                       your_title = "Mouse C22 Binary Heatmap",
                       label_size = 12)
```

The above binary heat map only shows clones present at a proportion of 1% or greater in at least one sample. Just like the previous heat map, one can see short-term clones at wk10 with a few sticking around through wk20, and a group of long-term clones that appear at wk14 and are present until sacrifice. 

## Clonal Contribution (bar or line plots)

A simpler way to view clonal patterns over time is by a line or bar chart showing the proportion of top clones. In the above heat maps for the monkey ZJ31, we could see that there are some large uni-lineage CD16+ NK cell clones. We can view the expansion of the top clones from the final timepoint through a stacked area line chart showing the proportion of each clone in CD16+ NK cell samples across time.

```{r clonal_contribution_line, echo=TRUE, warning = FALSE}
clonal_contribution(your_SE = se.monkey.sub, 
                    SAMPLENAME_choice = "ZJ31_20m_NK_CD56n_CD16p",
                    n_clones = 20, 
                    graph_type = "line", 
                    filter_by = "Cell_type", 
                    filter_selection = "NK_CD56n_CD16p", 
                    plot_over = "Months", 
                    linesize = 0.2)
```

The colored clones represent the top 20 clones in the 20 month CD16+ NK sample. The gray clones are other smaller clones which are found in the CD16+ samples at any of the four timepoints.

For data with fewer clones, a bar chart might be appropriate. We can view the data from mouse C22, previously shown as a heat map. One can hide the smaller clones through the plot_non_selected argument. We can also use categorical spacing on the x-axis rather than numeric.

```{r clonal_contribution_bar, echo=TRUE, warning = FALSE}
clonal_contribution(your_SE = se.mouse, 
                    SAMPLENAME_choice = "sac",
                    n_clones = 20, 
                    graph_type = "bar", 
                    filter_by = "Source", 
                    filter_selection = "PB", 
                    plot_over = "Weeks", 
                    keep_numeric = FALSE,
                    plot_non_selected = FALSE,
                    linesize = 0.2)
```

The bar chart makes the following conclusion very evident: by the final timepoint, the large fraction of hematopoiesis was coming from a small number of clones, most of which appeared at 14 weeks. 
