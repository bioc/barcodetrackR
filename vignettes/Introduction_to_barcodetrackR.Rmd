---
title: "barcodetrackR"
#date: "`r format(Sys.Date(), "%d %B %Y")`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: false
    css: readthedown_custom_2.css
---


``` {r setup, echo = FALSE}
#knitr::opts_chunk$set(width = 100)
```

# Introduction

## Motivation
[barcodetrackR](http://github.com/d93espinoza/barcodetrackR) is an R package developed for the analysis and visualization of clonal tracking data from cellular barcoding experiments.

## Installation
Currently, [barcodetrackR](http://github.com/d93espinoza/barcodetrackR) is available at Github and can be downloaded using the devtools package.
```{r installation, eval = FALSE}
devtools::install_github("d93espinoza/barcodetrackR")
```

## Contributors
The R package and functions were created by Diego A. Espinoza, Ryland Mortlock, Samson J. Koelle, and others at Cynthia Dunbar's laboratory at the National Heart, Lung, and Blood Institutes of Health. Issues should be addressed to https://github.com/d93espinoza/barcodetrackR/issues.



# Loading data

## Loading required packages

The [barcodetrackR](http://github.com/d93espinoza/barcodetrackR) package operates on [SummarizedExperiment](https://bioconductor.org/packages/release/bioc/html/SummarizedExperiment.html) objects from the Bioconductor repository. It stores associated colData for each sample in this object as well as any metadata. We load the `barcodetrackR` and `SummarizedExperiment` packages here for our analyses, as well as the `magrittr` package in order to improve legibility of code through using the pipe `%>%` operator.

```{r load packages required, eval = TRUE, warning=FALSE, message=FALSE}

require("magrittr")
require("barcodetrackR")
require("SummarizedExperiment")

```

## Creating objects with `create_SE`

For this vignette, we will load publically available data from the following papers (included in the package):

* [Wu, Chuanfeng, et al. "Clonal expansion and compartmentalized maintenance of rhesus macaque NK cell subsets." Science Immunology (2018)](http://dx.doi.org/10.1126/sciimmunol.aat9781)
* [Belderbos, Mirjam E., et al. "Donor-to-Donor Heterogeneity in the Clonal Dynamics of Transplanted Human Cord Blood Stem Cells in Murine Xenografts." Biology of Blood and Marrow Transplantation (2020)](http://dx.doi.org/10.1016/j.bbmt.2019.08.026)
* [Six, Emmanuelle, et al. "Clonal tracking in gene therapy patients reveals a diversity of human hematopoietic differentiation programs." Blood (2020)](http://doi.org/10.1182/blood.2019002350)

```{r load data, eval = TRUE}

system.file("sample_data/WuC_etal/monkey_ZJ31.txt", package = "barcodetrackR") %>%
  read.delim(row.names = 1) -> wu_dataframe

system.file("sample_data/WuC_etal/monkey_ZJ31_metadata.txt", package = "barcodetrackR") %>%
  read.delim() -> wu_metadata

wu_SE <- create_SE(your_data = wu_dataframe,
                   meta_data = wu_metadata,
                   threshold = 0)


system.file("sample_data/BelderbosME_etal/mouse_UBC_C22.txt", package = "barcodetrackR") %>%
  read.delim(row.names = 1) -> belderbos_dataframe

system.file("sample_data/BelderbosME_etal/mouse_UBC_C22_metadata.txt", package = "barcodetrackR") %>%
  read.delim() -> belderbos_metadata

belderbos_SE <- create_SE(your_data = belderbos_dataframe,
                          meta_data = belderbos_metadata,
                          threshold = 0)


system.file("sample_data/SixE_etal/WAS5_reads.txt", package = "barcodetrackR") %>%
  read.delim( row.names = 1) -> six_dataframe

system.file("sample_data/SixE_etal/WAS5_metadata.txt", package = "barcodetrackR") %>%
  read.delim() -> six_metadata

six_SE <- create_SE(your_data = six_dataframe,
                    meta_data = six_metadata,
                    threshold = 0)

```

In addition to reads data, the Six et al. paper includes "estimated abundance" data for each of these timepoints. We load these into a new SE in order to compare our analyses downstream.

```{r load custom counts, eval = TRUE}

system.file("sample_data/SixE_etal/WAS5_estabundance.txt", package = "barcodetrackR") %>%
  read.delim( row.names = 1) -> six_dataframe_2

six_ea_SE <- create_SE(your_data = six_dataframe_2,
                    meta_data = six_metadata,
                    threshold = 0)

```

Our input dataframes to create the `SummarizedExperiment` (SE) objects are each an n x m `data.frame` where there are n rows of observations (typically cellular barcodes, insertion sites, or the like) and the m columns are the samples. The input metadata must have row order identical to the order of the colums in its corresponding dataframe. The metadata must also have a column titled `SAMPLENAME` that denotes the column of `your_data` it refers to.

## Assays created by `create_SE`

`create_SE` takes the input `dataframe` and metadata and creates a SummarizedExperiment object with the following assays:

* `counts`: the raw values from the input dataframe
* `percentages`: the per-column proportions of each entry in each column
* `ranks`: the rank of each entry in each column
* `normalized`: the normalized read values (CPM)
* `logs`: the log of the normalized values

```{r list assays, eval = TRUE}
assays(six_SE)
```

# Correlations

## `scatter_plot`
A straightforward way to view the relationship between samples in a pairwise manner is to view basic scatter plots of two samples using the provided assays. We provide a `scatter_plot` function as part of the package.

```{r scatter_plot, eval = TRUE, fig.width = 7, fig.height=4}
Gr_B_20 <- c("ZJ31_20m_Gr", "ZJ31_20m_B")
Gr_T_20 <- c("ZJ31_20m_Gr", "ZJ31_20m_T")
wu_scatterplot_1 <- scatter_plot(wu_SE[,Gr_B_20], your_title = "Gr vs B")
wu_scatterplot_2 <- scatter_plot(wu_SE[,Gr_T_20], your_title = "Gr vs T")
cowplot::plot_grid(wu_scatterplot_1, wu_scatterplot_2, ncol = 2)
```

## `cor_plot`
A more comprehensive way to view the relationship between samples in a pairwise manner is to use a correlation plot. Here we view the Pearson correlation between the T, B, Gr, NK CD16+/CD56-, and NK CD16-/CD56+ fractions within the Wu dataset for the 6, 9.5, 12, and 20 month post-transplant timepoints.
```{r cor_plot 1, eval = TRUE, fig.width = 6, fig.height = 5}
wu_cor_plot_sample_selection <- colData(wu_SE)$SAMPLENAME[1:20]
cor_plot(wu_SE[,wu_cor_plot_sample_selection],
         method_corr = "pearson",
         plot_type = "color")
```


We can also use the spearman correlation as our metric of interest, and visualize our correlation plot using circles with areas proportional to the absolute value of the correlation and colors corresponding to the value of the correlations.
```{r cor_plot 2, eval = FALSE, fig.width = 6, fig.height = 5, warning=FALSE, message=FALSE}
cor_plot(wu_SE[,wu_cor_plot_sample_selection],
         method_corr = "spearman",
         plot_type = "circle")
```

We can return a table of the Pearson correlations as well as the p-values and confidence intervals for each of the comparisons above.
```{r cor_plot 3, eval = FALSE}
cor_plot(wu_SE[,wu_cor_plot_sample_selection],
         method_corr = "pearson",
         return_table = TRUE) %>% head
```

Above, we used two of the three available correlation visualizations (`'color"` and `"circle"`) using the standard color palette provided. A `no_negative` parameter is offered as well to eliminate negative correlations within the data, from which deriving biological meaning may be difficult.

# Clonal patterns

## `barcode_ggheatmap`

A useful visualization to study clonal patterns over time is by using a heat map which clusters the top clones based on relatedness and displays their proportion in each sample over time. our function `barcode_ggheatmap` does this by choosing the top N clones (`n_clones`) within each sample and tracking them over time; in a large number of cases, the large-contributing clones are of most interest to the user.

We first visualize the top 10 clones from the selected samples in the Wu dataset.

```{r barcode_ggheatmap wu_SE 1, echo=TRUE, warning = FALSE, fig.width = 12, fig.height=10}
barcode_ggheatmap(your_SE = wu_SE[,wu_cor_plot_sample_selection], n_clones = 10, label_size = 10)
```

We can also visualize the percentage contribution of each of these clones and add a dendogram cut into 4 clusters (based on the Euclidean distance between each clone's log assay). Here we plot the top 10 clones within the Six dataset and order the columns to group them by celltype.

```{r barcode_ggheatmap wu_SE 2, echo=TRUE, warning = FALSE, fig.width = 12, fig.height=10}
six_celltype_order <- c("m13_TCELLS", "m36_TCELLS", "m43_TCELLS", "m55_TCELLS",
                        "m13_BCELLS", "m36_BCELLS", "m43_BCELLS", "m55_BCELLS",
                        "m13_NKCELLS", "m36_NKCELLS", "m43_NKCELLS","m55_NKCELLS",
                        "m13_GRANULOCYTES", "m36_GRANULOCYTES", "m43_GRANULOCYTES",
                        "m55_GRANULOCYTES",
                        "m13_MONOCYTES", "m36_MONOCYTES", "m43_MONOCYTES","m55_MONOCYTES")
barcode_ggheatmap(your_SE = six_SE[,six_celltype_order],
                  n_clones = 5,
                  cellnote_size = 3,
                  label_size = 10,
                  dendro = TRUE,
                  clusters = 4,
                  cellnote_assay = "percentages",
                  distance_method = "euclidean")
```


The Belderbros dataset generally contains less clones than either the Wu or Six datasets.  Here is a heat map showing some detailed information about the top clones from the peripheral blood samples across time.
```{r heat_map_mouse, eval = TRUE, warning = FALSE}
belderbos_wk_samples_PB <- c("wk10", "wk14", "wk20", "wk27", "wk33")
barcode_ggheatmap(your_SE = belderbos_SE[,belderbos_wk_samples_PB],
                  n_clones = 10,
                  label_size = 10,
                  dendro = TRUE,
                  cellnote_size = 3,
                  cellnote_assay = "percentages",
                  clusters = 4)
```

Compared to the monkey data, the mouse data generally shows a smaller number of clones making up a large proportion of the hematopoiesis.


## `barcode_binary_heatmap`

In some cases, we may be interested in a global view of the presence or absence of barcodes across samples, regardless of read abundance. In that case, a binary heat map can be generated using `barcode_binary_heatmap` to give the simplest visual representation. Here we view a subset of the Belderbos dataset representing a total of `r nrow(belderbos_SE[,belderbos_wk_samples_PB])` clones.

```{r binary_heat_map, echo=TRUE, warning = FALSE}
barcode_binary_heatmap(your_SE = belderbos_SE[,belderbos_wk_samples_PB], label_size = 12)
```

## `clonal_contribution` (bar plot)

Another familiar way to visualize clonal patterns over time is using a line or bar chart showing the proportion of top clones. In the above heat maps for the monkey ZJ31, we could see that there are some large uni-lineage CD16+ NK cell clones. We can view the expansion of the top clones from the final timepoint through a stacked area line chart showing the proportion of each clone in CD16+ NK cell samples across time.

```{r clonal_contribution_line, echo=TRUE, warning = FALSE}

clonal_contribution(your_SE = wu_SE[,16:20],
                    SAMPLENAME_choice = "ZJ31_20m_NK_CD56n_CD16p",
                    n_clones = 10,
                    graph_type = "line",
                    filter_by = "celltype",
                    filter_selection = "NK_CD56n_CD16p",
                    plot_over = "months",
                    linesize = 0.2)
```

The colored clones represent the top 10 clones in the 10 month CD16+ NK sample. The gray clones are other smaller clones which are found in the CD16+ samples at any of the four timepoints.

For data with fewer clones, a bar chart might be appropriate. We can view the data from mouse C22, previously shown as a heat map. One can hide the smaller clones through the plot_non_selected argument. We can also use categorical spacing on the x-axis rather than numeric.

```{r clonal_contribution_bar, echo=TRUE, warning = FALSE, eval = FALSE}
clonal_contribution(your_SE = se.mouse,
                    SAMPLENAME_choice = "sac",
                    n_clones = 10,
                    graph_type = "bar",
                    filter_by = "Source",
                    filter_selection = "PB",
                    plot_over = "Weeks",
                    keep_numeric = FALSE,
                    plot_non_selected = FALSE,
                    linesize = 0.2)
```

The bar chart makes the following conclusion very evident: by the final timepoint, the large fraction of hematopoiesis was coming from a small number of clones, most of which appeared at 14 weeks.

# Bias

# Diversity

# Circos

# Utilities





